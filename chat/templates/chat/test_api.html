<!DOCTYPE html>
<html>
<head>
    <title>채팅</title>
    <meta charset="utf-8">
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Updated Babel with preset -->
    <script src="https://unpkg.com/@babel/standalone@7.22.17/babel.min.js"></script>
    <script>
        Babel.registerPreset("custom", {
            presets: [
                [Babel.availablePresets["env"], { targets: { chrome: "58" } }],
                Babel.availablePresets["react"]
            ]
        });
    </script>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            height: 100vh;
            margin: 0;
            background-color: #f8f9fa;
        }
        .chat-container {
            height: 100vh;
            display: flex;
            padding: 0;
            margin: 0;
            max-width: 100%;
        }
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: white;
        }
        .message-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        .message.sent {
            margin-left: auto;
        }
        .message.received {
            margin-right: auto;
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
        }
        .message.sent .message-bubble {
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .message.received .message-bubble {
            background-color: #e9ecef;
            color: black;
            border-bottom-left-radius: 5px;
        }
        .message-header {
            font-size: 0.8em;
            margin-bottom: 4px;
            color: #6c757d;
        }
        .message-timestamp {
            font-size: 0.75em;
            margin-top: 4px;
            color: #6c757d;
        }
        .room-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        .room-item {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .room-item:hover {
            background-color: #f8f9fa;
        }
        .room-item.active {
            background-color: #e9ecef;
        }
        .room-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .room-type {
            font-size: 0.8em;
            color: #6c757d;
        }
        .list-group-item {
            transition: all 0.2s ease;
            border-left: none;
            border-right: none;
        }
        .list-group-item:first-child {
            border-top: none;
        }
        .list-group-item:last-child {
            border-bottom: none;
        }
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .alert {
            margin-bottom: 0;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .input-group .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem;
        }
        .input-group .btn i {
            font-size: 0.875rem;
        }
        .message-input-container {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #dee2e6;
        }
        .message-input-wrapper {
            display: flex;
            gap: 10px;
        }
        .message-input {
            flex-grow: 1;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
        }
        .send-button {
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .send-button:hover {
            background-color: #0b5ed7;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: white;
            overflow-y: auto;
            max-height: 50vh;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .new-chat-button {
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .new-chat-button:hover {
            background-color: #0b5ed7;
        }
        /* 온라인 상태 관련 스타일 */
        .online-badge {
            font-size: 0.75em;
            padding: 0.25em 0.5em;
            border-radius: 1em;
        }
        .user-list-panel {
            transition: all 0.3s ease;
            animation: slideIn 0.3s forwards;
        }
        .system-message {
            text-align: center;
            background-color: rgba(0,0,0,0.05);
            padding: 6px 12px;
            border-radius: 15px;
            margin: 10px auto;
            font-size: 0.85em;
            color: #6c757d;
            max-width: 80%;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .cursor-pointer:hover {
            text-decoration: underline;
            color: #0d6efd;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        /* 추가된 인라인 스타일 대체용 클래스 */
        .online-user-card-body {
            max-height: 150px;
            overflow-y: auto;
        }
        .user-list-panel-container {
            width: 250px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            background-color: white;
        }
        .small-circle-icon {
            font-size: 0.5rem;
        }
        /* 사용자 프로필 영역 스타일 */
        .user-profile {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        .mini-avatar {
            width: 25px;
            height: 25px;
            font-size: 0.7rem;
        }
        .online-user-item {
            transition: all 0.2s;
        }
        .online-user-item:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        .dm-icon {
            visibility: hidden;
        }
        .online-user-item:hover .dm-icon {
            visibility: visible;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div id="root"></div>

    <script type="text/babel" data-presets="custom">
        function ChatApp() {
            // 필수 상태 변수들
            const [rooms, setRooms] = React.useState({ results: [] });
            const [messageText, setMessageText] = React.useState('');
            const [messages, setMessages] = React.useState([]);
            const [currentRoomId, setCurrentRoomId] = React.useState(null);
            const [socket, setSocket] = React.useState(null);
            const [globalSocket, setGlobalSocket] = React.useState(null);
            const [actionResult, setActionResult] = React.useState('');
            const [allOnlineUsers, setAllOnlineUsers] = React.useState([]);
            const [roomUsers, setRoomUsers] = React.useState([]);
            const [showUserList, setShowUserList] = React.useState(false);
            const [currentUser, setCurrentUser] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            
            // 검색 및 채팅방 생성 관련 상태
            const [searchQuery, setSearchQuery] = React.useState('');
            const [searchedUsers, setSearchedUsers] = React.useState([]);
            const [roomName, setRoomName] = React.useState('');
            const [roomType, setRoomType] = React.useState('group');
            const [joinRoomId, setJoinRoomId] = React.useState('');
            
            const messageContainerRef = React.useRef(null);
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // 초기화 효과
            React.useEffect(() => {
                // 사용자 정보 및 채팅방 불러오기
                getCurrentUser();
                getRooms();
                getAllOnlineUsers();
                
                // 전역 소켓 연결 (접속자 상태 업데이트용)
                connectGlobalSocket();
                
                // 온라인 사용자 정보 주기적 업데이트 (30초마다)
                const intervalId = setInterval(() => {
                    getAllOnlineUsers();
                    if (currentRoomId) {
                        getRoomUsers(currentRoomId);
                    }
                }, 30000);

                return () => {
                    clearInterval(intervalId);
                    if (globalSocket) {
                        globalSocket.close();
                    }
                    if (socket) {
                        socket.close();
                    }
                };
            }, []);

            // 메시지 스크롤 효과
            React.useEffect(() => {
                if (messageContainerRef.current) {
                    messageContainerRef.current.scrollTop = messageContainerRef.current.scrollHeight;
                }
            }, [messages]);

            // API 호출 함수들
            const getCurrentUser = async () => {
                try {
                    const response = await fetch('/api/users/me/');
                    const data = await response.json();
                    setCurrentUser(data);
                } catch (err) {
                    console.error('사용자 정보 로딩 실패:', err);
                }
            };

            const getRooms = async () => {
                try {
                    // 모든 채팅방을 불러옵니다.
                    const response = await fetch('/api/rooms/');
                    const data = await response.json();
                    setRooms(data);
                } catch (err) {
                    setActionResult('에러: ' + err.message);
                }
            };

            const getRecentMessages = async (roomId) => {
                try {
                    const response = await fetch(`/api/rooms/${roomId}/messages/`);
                    const data = await response.json();
                    // 최근 메시지를 시간순으로 정렬하여 설정
                    setMessages(data.results.map(msg => ({
                        type: 'message',
                        user: msg.sender.username,
                        message: msg.content,
                        timestamp: msg.created_at
                    })));
                } catch (err) {
                    console.error('최근 메시지 로딩 실패:', err);
                }
            };

            const getAllOnlineUsers = async () => {
                try {
                    const response = await fetch('/api/users/online/');
                    const data = await response.json();
                    console.log('온라인 사용자 데이터:', data);
                    
                    // 응답 구조 확인 및 안전하게 처리
                    if (data && data.users) {
                        setAllOnlineUsers(data.users);
                    } else {
                        console.error('예상치 못한 응답 구조:', data);
                        setAllOnlineUsers([]);
                    }
                } catch (err) {
                    console.error('온라인 사용자 정보 로딩 실패:', err);
                    setAllOnlineUsers([]);
                }
            };

            const getRoomUsers = async (roomId) => {
                try {
                    const response = await fetch(`/api/rooms/${roomId}/users/`);
                    const data = await response.json();
                    setRoomUsers(data.users);
                } catch (err) {
                    console.error('방 참여자 정보 로딩 실패:', err);
                }
            };

            // 채팅방 생성 및 참여 함수들
            const createRoom = async () => {
                try {
                    setIsLoading(true);
                    const response = await fetch('/api/rooms/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ name: roomName, room_type: roomType })
                    });
                    const data = await response.json();
                    setActionResult('채팅방이 생성되었습니다.');
                    await getRooms();
                    setRoomName('');
                    setIsLoading(false);
                } catch (err) {
                    setActionResult('에러: ' + err.message);
                    setIsLoading(false);
                }
            };

            const createDirectChat = async (userId) => {
                try {
                    setIsLoading(true);
                    setActionResult('1:1 대화방 생성 중...');
                    const response = await fetch('/api/rooms/create_direct_chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ user_id: userId })
                    });
                    const data = await response.json();
                    
                    if (response.ok) {
                        setActionResult('1:1 대화방이 생성되었습니다.');
                        await getRooms();
                        // 생성된 방으로 바로 입장
                        joinRoom(data.id);
                        setSearchedUsers([]);
                        setSearchQuery('');
                    } else {
                        setActionResult('에러: ' + data.error);
                    }
                    setIsLoading(false);
                } catch (err) {
                    setActionResult('에러: ' + err.message);
                    setIsLoading(false);
                }
            };

            const joinRoom = async (roomId = null) => {
                const targetRoomId = roomId || joinRoomId;
                if (!targetRoomId) {
                    setActionResult('에러: 방 ID를 입력해주세요.');
                    return;
                }
                
                try {
                    setIsLoading(true);
                    
                    // 현재 사용자가 해당 방에 이미 참여 중인지 확인
                    const room = rooms.results.find(r => r.id === targetRoomId);
                    
                    // 디버깅용 로그 추가
                    console.log('방 정보:', room);
                    console.log('현재 사용자:', currentUser);
                    console.log('참여자 목록:', room?.participants);
                    
                    // participants 배열이 있는지 확인하고, 현재 사용자의 ID가 포함되어 있는지 확인
                    const isAlreadyJoined = room && 
                                          Array.isArray(room.participants) && 
                                          currentUser && 
                                          room.participants.some(p => p.user && p.user.id === currentUser.id);
                    
                    console.log('이미 참여 중?', isAlreadyJoined);
                    
                    // 참여 중이 아니면 join API 호출
                    if (!isAlreadyJoined) {
                        const response = await fetch(`/api/rooms/${targetRoomId}/join/`, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrftoken }
                        });
                        
                        // 응답 확인 및 오류 처리
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || '채팅방 참여 중 오류가 발생했습니다.');
                        }
                        
                        setActionResult('방에 성공적으로 참여했습니다.');
                    } else {
                        setActionResult('채팅방에 입장했습니다.');
                    }
                    
                    setJoinRoomId(targetRoomId.toString());
                    setCurrentRoomId(targetRoomId);
                    
                    // 데이터 불러오기
                    await getRecentMessages(targetRoomId);
                    await getRoomUsers(targetRoomId);
                    
                    // 웹소켓 연결
                    connectWebSocket(targetRoomId);
                    
                    setIsLoading(false);
                } catch (err) {
                    console.error('채팅방 참여 오류:', err);
                    setActionResult('에러: ' + err.message);
                    setIsLoading(false);
                }
            };

            const leaveRoom = async () => {
                if (!currentRoomId) {
                    setActionResult('에러: 방에 참여 중이 아닙니다.');
                    return;
                }
                
                if (socket) {
                    socket.close();
                    setSocket(null);
                }
                
                try {
                    setIsLoading(true);
                    await fetch(`/api/rooms/${currentRoomId}/leave/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken }
                    });
                    
                    setActionResult('방에서 성공적으로 나갔습니다.');
                    setMessages([]);
                    setCurrentRoomId(null);
                    await getRooms();
                    setIsLoading(false);
                } catch (err) {
                    setActionResult('에러: ' + err.message);
                    setIsLoading(false);
                }
            };

            // 웹소켓 관련 함수들
            const connectWebSocket = (roomId) => {
                if (socket) {
                    socket.close();
                }

                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat/${roomId}/`;
                
                const newSocket = new WebSocket(wsUrl);
                setSocket(newSocket);

                newSocket.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.type === 'message' || data.type === 'join' || data.type === 'leave') {
                        setMessages(prev => [...prev, data]);
                    } else if (data.type === 'online_status') {
                        // 채팅방 사용자의 온라인 상태 업데이트
                        setRoomUsers(data.users);
                    }
                };

                // 하트비트 설정
                let heartbeatInterval;
                
                newSocket.onopen = () => {
                    // 5초마다 하트비트 메시지 전송
                    heartbeatInterval = setInterval(() => {
                        if (newSocket.readyState === WebSocket.OPEN) {
                            newSocket.send(JSON.stringify({ type: 'heartbeat' }));
                        }
                    }, 5000);
                };
                
                // 소켓 종료 시 하트비트 정지
                newSocket.addEventListener('close', () => {
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                    }
                });

                return newSocket;
            };

            const connectGlobalSocket = () => {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/online/`;
                
                console.log('글로벌 웹소켓 연결 시도:', wsUrl);
                const newSocket = new WebSocket(wsUrl);
                setGlobalSocket(newSocket);

                newSocket.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    console.log('글로벌 웹소켓 메시지 수신:', data);
                    if (data.type === 'online_users_update') {
                        console.log('온라인 사용자 목록 업데이트 요청 수신');
                        getAllOnlineUsers(); // 온라인 상태 변경 시 목록 갱신
                    }
                };

                newSocket.onopen = () => {
                    console.log('글로벌 웹소켓 연결 성공');
                    
                    // 5초마다 하트비트 메시지 전송
                    const heartbeatInterval = setInterval(() => {
                        if (newSocket.readyState === WebSocket.OPEN) {
                            newSocket.send(JSON.stringify({ type: 'heartbeat' }));
                        }
                    }, 5000);
                    
                    // 소켓 종료 시 하트비트 정지
                    newSocket.addEventListener('close', () => {
                        if (heartbeatInterval) {
                            clearInterval(heartbeatInterval);
                        }
                    });
                };

                newSocket.onclose = () => {
                    console.log('글로벌 WebSocket 연결이 종료되었습니다.');
                    // 재연결 시도
                    setTimeout(() => {
                        connectGlobalSocket();
                    }, 3000);
                };

                newSocket.onerror = (error) => {
                    console.error('글로벌 웹소켓 오류:', error);
                };

                return newSocket;
            };

            // 채팅 기능 관련 함수들
            const sendMessage = () => {
                if (!messageText.trim()) {
                    return;
                }

                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    setActionResult('에러: WebSocket 연결이 없습니다.');
                    return;
                }

                try {
                    socket.send(JSON.stringify({ message: messageText }));
                    setMessageText('');
                } catch (err) {
                    console.error('메시지 전송 오류:', err);
                    setActionResult('에러: 메시지 전송에 실패했습니다.');
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const toggleUserList = () => {
                setShowUserList(!showUserList);
            };

            // 헬퍼 함수들
            const getInitial = (name) => {
                return name ? name.charAt(0).toUpperCase() : '?';
            };

            // 온라인 상태 표시 아이콘 컴포넌트
            const OnlineStatusIcon = ({ isOnline }) => (
                <span className={`ms-2 badge ${isOnline ? 'bg-success' : 'bg-secondary'} online-badge`}>
                    <i className="fas fa-circle me-1 small-circle-icon"></i>
                    {isOnline ? '온라인' : '오프라인'}
                </span>
            );

            // UI 렌더링
            return (
                <div className="chat-container">
                    <div className="sidebar">
                        {/* 사용자 프로필 정보 */}
                        {currentUser && (
                            <div className="user-profile d-flex align-items-center">
                                <div className="user-avatar">
                                    {getInitial(currentUser.username)}
                                </div>
                                <div>
                                    <div className="fw-bold">{currentUser.username}</div>
                                    <small className="text-muted">{currentUser.email}</small>
                                </div>
                            </div>
                        )}

                        <div className="sidebar-header">
                            <div className="d-flex justify-content-between align-items-center mb-3">
                                <h4 className="mb-0">채팅</h4>
                                <button 
                                    className="btn btn-sm btn-outline-info" 
                                    onClick={getAllOnlineUsers}
                                    title="온라인 상태 새로고침"
                                    disabled={isLoading}
                                >
                                    <i className={`fas ${isLoading ? 'fa-spinner fa-spin' : 'fa-sync-alt'}`}></i>
                                </button>
                            </div>
                            
                            {/* 새 그룹 채팅방 생성 */}
                            <div className="mb-3">
                                <div className="input-group">
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="새 그룹 채팅방 이름"
                                        value={roomName}
                                        onChange={(e) => setRoomName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && createRoom()}
                                        disabled={isLoading}
                                    />
                                    <button 
                                        className="btn btn-success" 
                                        onClick={createRoom}
                                        disabled={!roomName.trim() || isLoading}
                                    >
                                        <i className="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            {/* 알림 메시지 */}
                            {actionResult && (
                                <div className="alert alert-info py-2 small">{actionResult}</div>
                            )}
                            
                            {/* 접속자 목록 */}
                            <div className="mb-3">
                                <div className="card">
                                    <div className="card-header py-2 d-flex justify-content-between align-items-center">
                                        <small className="fw-bold">접속자 목록</small>
                                        <span className="badge bg-success online-badge">{allOnlineUsers ? `${allOnlineUsers.filter(user => user.is_online).length}/${allOnlineUsers.length}` : '0/0'}</span>
                                    </div>
                                    <div className="card-body p-0 online-user-card-body">
                                        <div className="list-group list-group-flush small">
                                            {allOnlineUsers && allOnlineUsers
                                                .filter(user => user.is_online)
                                                .map(user => (
                                                <div 
                                                    key={user.id} 
                                                    className={`list-group-item py-2 d-flex justify-content-between align-items-center cursor-pointer online-user-item ${currentUser && user.id === currentUser.id ? 'bg-light' : ''}`}
                                                    onClick={() => currentUser && user.id !== currentUser.id && !isLoading && createDirectChat(user.id)}
                                                >
                                                    <div className="d-flex align-items-center">
                                                        <div className="user-avatar mini-avatar me-2">
                                                            {getInitial(user.username)}
                                                        </div>
                                                        <span>
                                                            {user.username}
                                                            {currentUser && user.id === currentUser.id && <span className="ms-1 badge bg-info">나</span>}
                                                        </span>
                                                    </div>
                                                    <div className="d-flex align-items-center">
                                                        <OnlineStatusIcon isOnline={true} />
                                                        {currentUser && user.id !== currentUser.id && (
                                                            <i className="fas fa-comment-dots text-primary ms-1 dm-icon"></i>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {allOnlineUsers && allOnlineUsers.filter(user => user.is_online).length === 0 && (
                                                <div className="list-group-item py-2 text-center text-muted">
                                                    접속자가 없습니다
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 채팅방 목록 */}
                        <ul className="room-list">
                            {rooms.results.map(room => {
                                // 방에 참여 중인 온라인 사용자 수 계산
                                const roomOnlineCount = room.participants_count && allOnlineUsers ? 
                                    allOnlineUsers.filter(user => 
                                        room.participants && room.participants.includes(user.id) && user.is_online
                                    ).length : 0;
                                
                                return (
                                    <li
                                        key={room.id}
                                        className={`room-item ${currentRoomId === room.id ? 'active' : ''}`}
                                        onClick={() => !isLoading && joinRoom(room.id)}
                                    >
                                        <div className="room-name">
                                            <i className={`fas fa-${room.room_type === 'direct' ? 'user' : 'users'} me-2`}></i>
                                            {room.name}
                                            {roomOnlineCount > 0 && (
                                                <span className="ms-2 badge bg-success online-badge">
                                                    <i className="fas fa-circle me-1 small-circle-icon"></i>
                                                    {roomOnlineCount}
                                                </span>
                                            )}
                                        </div>
                                        <div className="room-type text-muted small">
                                            {room.room_type === 'direct' ? '1:1 대화' : '그룹 채팅'}
                                        </div>
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                    <div className="main-content">
                        {currentRoomId ? (
                            <React.Fragment>
                                <div className="chat-header">
                                    <div className="d-flex align-items-center">
                                        <h5 className="mb-0">
                                            {rooms.results && rooms.results.find(r => r.id === currentRoomId) && rooms.results.find(r => r.id === currentRoomId).name}
                                        </h5>
                                        <button 
                                            className="btn btn-sm btn-outline-primary ms-3" 
                                            onClick={toggleUserList}
                                            title="참여자 목록"
                                        >
                                            <i className="fas fa-users me-1"></i>
                                            {roomUsers && roomUsers.length > 0 ? `${roomUsers.filter(user => user.is_online).length}/${roomUsers.length}` : '0/0'}
                                        </button>
                                    </div>
                                    <button 
                                        className="btn btn-outline-danger"
                                        onClick={leaveRoom}
                                    >
                                        나가기
                                    </button>
                                </div>
                                
                                <div className="d-flex flex-grow-1">
                                    {/* 참여자 목록 패널 */}
                                    {showUserList && (
                                        <div className="user-list-panel user-list-panel-container">
                                            <div className="p-3 border-bottom">
                                                <h6 className="mb-2">참여자 목록</h6>
                                                <div className="d-flex justify-content-between small mb-1">
                                                    <span>총 참여자</span>
                                                    <span>{roomUsers ? roomUsers.length : 0}명</span>
                                                </div>
                                                <div className="d-flex justify-content-between small text-success">
                                                    <span>온라인</span>
                                                    <span>{roomUsers ? roomUsers.filter(user => user.is_online).length : 0}명</span>
                                                </div>
                                            </div>
                                            <ul className="list-group list-group-flush">
                                                {roomUsers && roomUsers.map(user => (
                                                    <li key={user.id} className="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{user.username}</span>
                                                        <OnlineStatusIcon isOnline={user.is_online} />
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                    
                                    {/* 메시지 컨테이너 */}
                                    <div className="message-container flex-grow-1" ref={messageContainerRef}>
                                        {messages.map((msg, index) => (
                                            <div key={index} className={`message ${msg.user === '{{ user.username }}' ? 'sent' : 'received'}`}>
                                                {msg.type === 'message' ? (
                                                    <React.Fragment>
                                                        <div className="message-header">
                                                            {msg.user}
                                                        </div>
                                                        <div className="message-bubble">
                                                            {msg.message}
                                                        </div>
                                                        {msg.timestamp && (
                                                            <div className="message-timestamp">
                                                                {new Date(msg.timestamp).toLocaleString()}
                                                            </div>
                                                        )}
                                                    </React.Fragment>
                                                ) : (
                                                    <div className="system-message">
                                                        {msg.user}님이 {msg.type === 'join' ? '입장' : '퇴장'}하셨습니다.
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="message-input-container">
                                    <div className="message-input-wrapper">
                                        <input
                                            type="text"
                                            className="message-input"
                                            placeholder="메시지를 입력하세요..."
                                            value={messageText}
                                            onChange={(e) => setMessageText(e.target.value)}
                                            onKeyDown={handleKeyPress}
                                        />
                                        <button 
                                            className="send-button" 
                                            onClick={sendMessage}
                                            disabled={!messageText.trim()}
                                        >
                                            <i className="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    <div className="d-flex justify-content-between mt-2">
                                        <small className="text-muted">
                                            {showUserList ? (
                                                <span className="cursor-pointer" onClick={toggleUserList}>
                                                    <i className="fas fa-eye-slash me-1"></i>참여자 목록 숨기기
                                                </span>
                                            ) : (
                                                <span className="cursor-pointer" onClick={toggleUserList}>
                                                    <i className="fas fa-eye me-1"></i>참여자 목록 보기 
                                                    <span className="ms-1 badge bg-success online-badge">
                                                        {roomUsers ? roomUsers.filter(user => user.is_online).length : 0}/{roomUsers ? roomUsers.length : 0}
                                                    </span>
                                                </span>
                                            )}
                                        </small>
                                        <small className="text-muted">
                                            <i className="fas fa-circle text-success me-1 small-circle-icon"></i>
                                            {roomUsers ? roomUsers.filter(user => user.is_online).length : 0}명 접속 중
                                        </small>
                                    </div>
                                </div>
                            </React.Fragment>
                        ) : (
                            <div className="d-flex align-items-center justify-content-center h-100">
                                <div className="text-center text-muted">
                                    <i className="fas fa-comments fa-3x mb-3"></i>
                                    <h5>채팅방을 선택해주세요</h5>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatApp />);
    </script>
</body>
</html> 